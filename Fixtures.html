<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Fixtures</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
:root{
  --bg:#020617;
  --card:#0b1220;
  --accent:#22c55e;
  --text:#e5e7eb;
  --muted:#9ca3af;
  --border:rgba(148,163,184,.35);
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:Poppins,sans-serif;
  background:radial-gradient(circle at top,#1f2937,#020617 60%);
  color:var(--text);
  padding:16px;
}
.page{max-width:480px;margin:auto}
.header h1{font-size:22px}
.pill{
  display:inline-flex;gap:6px;align-items:center;
  margin-top:6px;
  padding:4px 10px;
  border-radius:999px;
  border:1px solid var(--border);
  font-size:10px;
  color:var(--muted);
}
.pill span{
  width:6px;height:6px;border-radius:50%;
  background:var(--accent);
  box-shadow:0 0 0 4px rgba(34,197,94,.2);
}

/* SECTION */
.section-title{
  margin:22px 0 10px;
  font-size:13px;
  font-weight:700;
  text-transform:uppercase;
  letter-spacing:.08em;
  color:var(--muted);
  border-left:3px solid var(--accent);
  padding-left:10px;
}

/* GRID */
.fixture-grid{
  display:grid;
  grid-template-columns:1fr;
  gap:12px;
}
@media(min-width:600px){
  .fixture-grid{grid-template-columns:repeat(2,1fr)}
}

/* CARD */
.fixture-card{
  background:linear-gradient(135deg,#0f172a,#020617);
  border:1px solid var(--border);
  border-radius:14px;
  padding:14px;
  box-shadow:0 10px 20px rgba(15,23,42,.85);
  cursor:pointer;
  transition:transform 0.2s;
}
.fixture-card:hover{
  transform:translateY(-2px);
}
.teams-score{
  font-size:18px;
  font-weight:700;
}
.fixture-meta{
  font-size:11px;
  color:var(--muted);
  margin-top:2px;
}
.status{
  display:inline-block;
  margin-top:6px;
  padding:3px 10px;
  border-radius:999px;
  font-size:10px;
  font-weight:600;
  text-transform:uppercase;
}
.status.scheduled{
  color:#fde68a;
  background:rgba(234,179,8,.15);
}
.status.completed{
  color:#86efac;
  background:rgba(34,197,94,.2);
}

/* MODAL */
.modal{
  position:fixed;inset:0;
  background:rgba(15,23,42,.9);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:50;
}
.modal.show{
  display:flex;
}
.modal-box{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:16px;
  padding:20px;
  width:90%;
  max-width:400px;
  position:relative;
}
.modal-box h3{
  font-size:18px;
  margin-bottom:12px;
}
.modal-box button{
  margin-top:16px;
  padding:8px 20px;
  border-radius:999px;
  border:1px solid var(--border);
  background:#020617;
  color:#fff;
  cursor:pointer;
  font-family:Poppins,sans-serif;
}
.modal-box button:hover{
  background:#1f2937;
}
</style>
</head>

<body>
<div class="page">

  <div class="header">
    <h1>Fixtures</h1>
    <div class="pill"><span></span>Live Schedule</div>
  </div>

  <div id="fixtures"></div>
</div>

<!-- MODAL -->
<div class="modal" id="modal" onclick="closeModal()">
  <div class="modal-box" onclick="event.stopPropagation()">
    <h3 id="modalTitle">Match Details</h3>
    <div id="modalInfo"></div>
    <button onclick="closeModal()">Close</button>
  </div>
</div>

<script>
console.log('Script started');

const FIXTURES_CSV =
'https://docs.google.com/spreadsheets/d/e/2PACX-1vRDj6H_iXEcpkOJ6PxDdDXEU2I-nWYWiXAYK9EFCGmgh49urC7vJv_RroGbND3DBFBUFhlQ7yNbGSra/pub?gid=1634159170&single=true&output=csv';

const RESULTS_CSV =
'https://docs.google.com/spreadsheets/d/e/2PACX-1vRDj6H_iXEcpkOJ6PxDdDXEU2I-nWYWiXAYK9EFCGmgh49urC7vJv_RroGbND3DBFBUFhlQ7yNbGSra/pub?gid=1925711967&single=true&output=csv';

const SCORERS_CSV =
'https://docs.google.com/spreadsheets/d/e/2PACX-1vRDj6H_iXEcpkOJ6PxDdDXEU2I-nWYWiXAYK9EFCGmgh49urC7vJv_RroGbND3DBFBUFhlQ7yNbGSra/pub?gid=695970577&single=true&output=csv';

const PLAYERS_CSV =
'https://docs.google.com/spreadsheets/d/e/2PACX-1vRDj6H_iXEcpkOJ6PxDdDXEU2I-nWYWiXAYK9EFCGmgh49urC7vJv_RroGbND3DBFBUFhlQ7yNbGSra/pub?gid=1639912807&single=true&output=csv';

let scorers=[], playerMap={}, resultMap={};

console.log('Papa:', typeof Papa);

// Helper function to trim all keys in objects
function trimKeys(arr) {
  return arr.map(obj => {
    const trimmed = {};
    Object.keys(obj).forEach(key => {
      trimmed[key.trim()] = typeof obj[key] === 'string' ? obj[key].trim() : obj[key];
    });
    return trimmed;
  });
}

Promise.all([
  fetch(FIXTURES_CSV).then(r=>r.text()),
  fetch(RESULTS_CSV).then(r=>r.text()),
  fetch(SCORERS_CSV).then(r=>r.text()),
  fetch(PLAYERS_CSV).then(r=>r.text())
]).then(([fCsv,rCsv,sCsv,pCsv])=>{
  console.log('Data loaded successfully');

  const fixtures=trimKeys(Papa.parse(fCsv,{header:true,skipEmptyLines:true}).data);
  const results=trimKeys(Papa.parse(rCsv,{header:true,skipEmptyLines:true}).data);
  scorers=trimKeys(Papa.parse(sCsv,{header:true,skipEmptyLines:true}).data);
  const players=trimKeys(Papa.parse(pCsv,{header:true,skipEmptyLines:true}).data);

  console.log('Fixtures count:', fixtures.length);
  console.log('First fixture:', fixtures[0]);
  console.log('First scorer:', scorers[0]);
  console.log('First player:', players[0]);

  players.forEach(p=>{
    if(p['Player ID']) {
      playerMap[p['Player ID']]={name:p['Player Name'],team:p['Team ID']};
    }
  });
  
  results.forEach(r=>{
    if(r['Match ID']) {
      resultMap[r['Match ID']]=r;
    }
  });

  const root=document.getElementById('fixtures');
  root.innerHTML='';

  const sections=[
    {t:'Pool A – League', f:m=>m.Stage==='League'&&m.Pool==='Pool A'},
    {t:'Pool B – League', f:m=>m.Stage==='League'&&m.Pool==='Pool B'},
    {t:'Semi Finals', f:m=>m.Stage==='Semi Final'},
    {t:'Final', f:m=>m.Stage==='Final'}
  ];

  sections.forEach(sec=>{
    const list=fixtures.filter(sec.f);
    console.log('Section:', sec.t, 'Count:', list.length);
    if(!list.length)return;

    const sectionTitle=document.createElement('div');
    sectionTitle.className='section-title';
    sectionTitle.textContent=sec.t;
    root.appendChild(sectionTitle);

    const grid=document.createElement('div');
    grid.className='fixture-grid';

    list.forEach(m=>{
      const r=resultMap[m['Match ID']];
      const done=m.Status==='Completed';
      const score=done&&r
        ? `${m['Team A']} (${r['Team A Goals']}) - (${r['Team B Goals']}) ${m['Team B']}`
        : `${m['Team A']} vs ${m['Team B']}`;

      const c=document.createElement('div');
      c.className='fixture-card';
      c.innerHTML=`
        <div class="teams-score">${score}</div>
        <div class="fixture-meta">${m.Date} • ${m['Start Time']}</div>
        <div class="status ${m.Status.toLowerCase()}">${m.Status}</div>`;
      
      c.addEventListener('click', function() {
        console.log('Card clicked!', m['Team A'], 'vs', m['Team B']);
        openModal(m,r);
      });
      
      grid.appendChild(c);
    });

    root.appendChild(grid);
  });
  
  console.log('Cards rendered');
}).catch(err=>{
  console.error('Error loading data:', err);
  document.getElementById('fixtures').innerHTML='<p style="color:red">Error loading data. Check console.</p>';
});

function openModal(m,r){
  console.log('Opening modal for:', m['Team A'], 'vs', m['Team B']);
  console.log('Match data:', m);
  console.log('Result data:', r);
  
  let html=`
<div style="font-size:20px;font-weight:700;margin-bottom:8px">
${m['Team A']} (${r?.['Team A Goals']||0}) - (${r?.['Team B Goals']||0}) ${m['Team B']}
</div>
<div style="font-size:12px;color:#9ca3af;margin-bottom:12px">${m.Date} • ${m['Start Time']}</div>
<hr style="margin:12px 0;border:none;border-top:1px solid #334155">`;

  const ms=scorers.filter(s=>s['Match ID']===m['Match ID']);
  console.log('Matching scorers:', ms);
  console.log('Player map:', playerMap);
  
  if(!ms.length) {
    html+=`<p style="color:#9ca3af;margin-top:12px">No goals recorded</p>`;
  } else {
    html+=`<h4 style="margin-top:12px;margin-bottom:8px;font-size:14px">Goal Scorers</h4>`;
    ms.forEach(s=>{
      console.log('Scorer:', s);
      const p=playerMap[s['Player ID']];
      console.log('Player found:', p);
      if(p) {
        html+=`<p style="margin:6px 0">${p.name} (${p.team}) × ${s.Goals}</p>`;
      } else {
        html+=`<p style="margin:6px 0;color:#ef4444">Unknown Player (ID: ${s['Player ID']}) × ${s.Goals}</p>`;
      }
    });
  }

  document.getElementById('modalInfo').innerHTML=html;
  document.getElementById('modal').classList.add('show');
}

function closeModal(){
  console.log('Closing modal');
  document.getElementById('modal').classList.remove('show');
}
</script>

</body>
</html>
