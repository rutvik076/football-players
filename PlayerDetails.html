<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Players by Position</title>
  <style>
    body{font-family: Arial; padding:20px}
    .position{margin-bottom:30px}
    .position h2{background:#eee;padding:8px;border-radius:6px}
    .cards{display:flex;flex-wrap:wrap;gap:12px}
    .card{width:180px;border:1px solid #ddd;border-radius:8px;padding:8px;text-align:center}
    .card img{width:100%;height:140px;object-fit:cover;border-radius:6px}
    .name{font-weight:600;margin-top:6px}
    .pos{color:#666;font-size:13px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
</head>
<body>
  <h1>Team Players</h1>
  <div id="container">Loadingâ€¦</div>

<script>
// CONFIG: replace these
const SHEET_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRjhzBi9CVvUR9mi5LfyrZcTbFoHpjtz7qe2EyRYcllRuWI_E4XGactvupyZr9ZdQ_LfOOrzW_g3jnA/pub?output=csv";

// Helper: convert Drive open?id=... or /file/d/ID/... to direct image URL
function driveDirectUrl(url) {
  if (!url) return "";

  // Correct regex without invalid flags
  const idMatch = url.match(/(?:open\?id=|\/file\/d\/|id=)([a-zA-Z0-9_-]{10,})/);

  return idMatch
    ? `https://drive.google.com/uc?export=view&id=${idMatch[1]}`
    : url;
}


// Parse CSV simple
function parseCSV(text){
  const lines = text.trim().split(/\\r?\\n/);
  const headers = lines.shift().split(',').map(h=>h.trim().replace(/^"|"$/g,''));
  return lines.map(line=>{
    // simple CSV split that handles quoted commas
    const values = [];
    let cur="", inQ=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch==='\"'){ inQ=!inQ; continue;}
      if(ch===',' && !inQ){ values.push(cur); cur=""; continue;}
      cur+=ch;
    }
    values.push(cur);
    const obj = {};
    headers.forEach((h,i)=> obj[h]= (values[i]||"").trim().replace(/^"|"$/g,''));
    return obj;
  });
}

function render(data){
  const container = document.getElementById('container');
  // assume headers include "Player Name", "Player Position", "Player Image"
  const groups = {};
  data.forEach(row=>{
    const pos = row['Player Position'] || row['Player position'] || row['PlayerPosition'] || 'Unknown';
    groups[pos] = groups[pos] || [];
    groups[pos].push({
      name: row['Player Name'] || row['Player name'] || row['PlayerName'] || 'No name',
      image: driveDirectUrl(row['Player Image'] || row['Player image'] || '')
    });
  });

  container.innerHTML = '';
  for(const pos of Object.keys(groups).sort()){
    const div = document.createElement('div'); div.className='position';
    div.innerHTML = `<h2>${pos} (${groups[pos].length})</h2>`;
    const cards = document.createElement('div'); cards.className='cards';
    groups[pos].forEach(p=>{
      const c = document.createElement('div'); c.className='card';
      c.innerHTML = `<img src="${p.image}" alt="${p.name}" referrerpolicy="no-referrer"
  onerror="
    try{
      if(this.dataset.retried!=='1'){
        this.dataset.retried='1';
        const id=(this.src.match(/[?&]id=([a-zA-Z0-9_-]{10,})/)||[])[1];
        if(id){ this.src='https://drive.google.com/thumbnail?id='+id+'&sz=w640-h400'; return; }
      }
    }catch(e){}
    console.warn('Image final failed:', this.src);
    this.src='https://via.placeholder.com/280x200?text=No+Image';
    this.style.opacity=0.6;
  ">
                     <div class="name">${p.name}</div>
                     <div class="pos">${pos}</div>`;
      cards.appendChild(c);
    });
    div.appendChild(cards);
    container.appendChild(div);
  }
}

// Fetch CSV and show
fetch(SHEET_CSV)
  .then(r => r.text())
  .then(txt => {
    // parse without header so we can detect where the real header row is
    const parsed = Papa.parse(txt, { header: false, skipEmptyLines: true });
    const rows = parsed.data;

    // find the header row index by looking for "Player Name" or similar
    const hdrIdx = rows.findIndex(r =>
      r.some(cell => typeof cell === 'string' && /player\s*name/i.test(cell))
    );
    if (hdrIdx === -1) {
      throw new Error('Header row not found (needs "Player Name").');
    }

    // build objects using that header row
    const headers = rows[hdrIdx].map(h => (h||'').trim());
    const data = rows.slice(hdrIdx + 1).map(r => {
      const obj = {};
      headers.forEach((h,i) => obj[h] = r[i] === undefined ? '' : r[i]);
      return obj;
    });
    render(data);
  })
  .catch(err => {
    document.getElementById('container').textContent = 'Error loading sheet: ' + err;
  });
</script>
</body>
</html>
